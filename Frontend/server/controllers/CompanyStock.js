const express = require('express');
const router = express.Router();
const axios = require("axios");

const PYTHON_BACKEND_URL = process.env.PYTHON_BACKEND_URL || "http://localhost:8000";

const dummyData = {       
  financial_analysis: {
    financial_ratios: {
      EPS: 18.25,
      'P/E Ratio': 32.4,
      ROE: 0.29,
      'Current Ratio': 3.1,
      'Debt-to-Equity': 0.45
    },
    summary: {
      Profitability: 'Strong',
      Liquidity: 'Stable',
      Solvency: 'Robust'
    }
  },  
  technical_indicators: [       
    {
      name: '2025-07-02',       
      Open: 715.3300170898438,  
      High: 720.2999877929688,  
      Low: 712.7999877929688,   
      Close: 713.5700073242188, 
      Volume: 9336700,
      Dividends: 0,
      'Stock Splits': 0,        
      SMA_20: 703.0166442871093,
      EMA_20: 699.3933728889674,
      RSI: 62.059488579607695,  
      MACD: 21.213168317872714,
      MACD_Signal: 22.167860599238388,
      MACD_Hist: -0.9546922813656735,
      BB_Middle: 703.0166442871093,
      BB_Upper: 735.6892585476772,
      BB_Lower: 670.3440300265414,
      'Stoch_%K': 57.0036612679667,
      'Stoch_%D': 71.06232035195099,
      ATR: 14.92186280112154
    },
    {
      name: '2025-07-03',
      Open: 726.6099853515625,
      High: 729.030029296875,
      Low: 714.4199829101562,
      Close: 719.010009765625,
      Volume: 8601700,
      Dividends: 0,
      'Stock Splits': 0,
      SMA_20: 704.5960906982422,
      EMA_20: 701.2616240200776,
      RSI: 58.76552694306328,
      MACD: 20.24388860670456,
      MACD_Signal: 21.78306620073162,
      MACD_Hist: -1.5391775940270627,
      BB_Middle: 704.5960906982422,
      BB_Upper: 737.1482248352632,
      BB_Lower: 672.0439565612211,
      'Stoch_%K': 58.26954018681702,
      'Stoch_%D': 60.29231062039011,
      ATR: 14.588214810807761
    },
    {
      name: '2025-07-07',
      Open: 717.5999755859375,
      High: 727,
      Low: 713.510009765625,
      Close: 718.3499755859375,
      Volume: 9457100,
      Dividends: 0,
      'Stock Splits': 0,
      SMA_20: 706.3089080810547,
      EMA_20: 702.8890860739691,
      RSI: 59.648534091753014,
      MACD: 19.201129541093906,
      MACD_Signal: 21.266678868804078,
      MACD_Hist: -2.0655493277101726,
      BB_Middle: 706.3089080810547,
      BB_Upper: 737.9098418692067,
      BB_Lower: 674.7079742929027,
      'Stoch_%K': 57.316147461131216,
      'Stoch_%D': 57.52978297197163,
      ATR: 14.656680383533267
    },
    {
      name: '2025-07-08',
      Open: 721.5700073242188,
      High: 722.9099731445312,
      Low: 714.8099975585938,
      Close: 720.6699829101562,
      Volume: 7770700,
      Dividends: 0,
      'Stock Splits': 0,
      SMA_20: 707.4837280273438,
      EMA_20: 704.5825048202727,
      RSI: 57.044930245189526,
      MACD: 18.35040858346099,
      MACD_Signal: 20.683424811735463,
      MACD_Hist: -2.3330162282744737,
      BB_Middle: 707.4837280273438,
      BB_Upper: 739.4001406113905,
      BB_Lower: 675.567315443297,
      'Stoch_%K': 60.66730437772478,
      'Stoch_%D': 58.750997341891,
      ATR: 14.152878637939931
    },
    {
      name: '2025-07-09',
      Open: 722.719970703125,
      High: 737.530029296875,
      Low: 722.719970703125,
      Close: 732.780029296875,
      Volume: 11418000,
      Dividends: 0,
      'Stock Splits': 0,
      SMA_20: 709.4464111328125,
      EMA_20: 707.2679833418539,
      RSI: 61.20100262359677,
      MACD: 18.440811435726687,
      MACD_Signal: 20.23490213653371,
      MACD_Hist: -1.794090700807022,
      BB_Middle: 709.4464111328125,
      BB_Upper: 742.5544481598486,
      BB_Lower: 676.3383741057764,
      'Stoch_%K': 78.1597774770446,
      'Stoch_%D': 65.38107643863351,
      ATR: 14.433813437298914
    },
    {
      name: '2025-07-10',
      Open: 731.5499877929688,
      High: 735.7999877929688,
      Low: 719.5999755859375,
      Close: 727.239990234375,
      Volume: 9913600,
      Dividends: 0,
      'Stock Splits': 0,
      SMA_20: 710.7154113769532,
      EMA_20: 709.1700792363797,
      RSI: 57.35949690948774,
      MACD: 17.859547745926534,
      MACD_Signal: 19.759831258412273,
      MACD_Hist: -1.9002835124857391,
      BB_Middle: 710.7154113769532,
      BB_Upper: 744.5370034173193,
      BB_Lower: 676.8938193365871,
      'Stoch_%K': 70.15741471349288,
      'Stoch_%D': 69.6614988560874,
      ATR: 14.660763524466915
    },
    {
      name: '2025-07-11',
      Open: 722.5,
      High: 725.1599731445312,
      Low: 709.7000122070312,
      Close: 717.510009765625,
      Volume: 10873900,
      Dividends: 0,
      'Stock Splits': 0,
      SMA_20: 711.910595703125,
      EMA_20: 709.9643583344032,
      RSI: 56.87256386336787,
      MACD: 16.424433333380307,
      MACD_Signal: 19.092751673405882,
      MACD_Hist: -2.668318340025575,
      BB_Middle: 711.910595703125,
      BB_Upper: 744.8647960669093,
      BB_Lower: 678.9563953393406,
      'Stoch_%K': 56.102850744755415,
      'Stoch_%D': 68.14001431176428,
      ATR: 14.694411093537871
    },
    {
      name: '2025-07-14',
      Open: 717.5999755859375,
      High: 728,
      Low: 716.5499877929688,
      Close: 720.9199829101562,
      Volume: 8939400,
      Dividends: 0,
      'Stock Splits': 0,
      SMA_20: 713.3152496337891,
      EMA_20: 711.0077511511416,
      RSI: 57.95670355087584,
      MACD: 15.384903564899105,
      MACD_Signal: 18.351182051704527,
      MACD_Hist: -2.9662784868054217,
      BB_Middle: 713.3152496337891,
      BB_Upper: 745.2227557776969,
      BB_Lower: 681.4077434898813,
      'Stoch_%K': 61.028419284735044,
      'Stoch_%D': 62.42956158099443,
      ATR: 14.84823360278674
    },
    {
      name: '2025-07-15',
      Open: 723.9000244140625,
      High: 724.469970703125,
      Low: 709.8200073242188,
      Close: 710.3900146484375,
      Volume: 11529500,
      Dividends: 0,
      'Stock Splits': 0,
      SMA_20: 714.7175018310547,
      EMA_20: 710.9489191032651,
      RSI: 57.940938181345594,
      MACD: 13.555133160568516,
      MACD_Signal: 17.391972273477325,
      MACD_Hist: -3.836839112908809,
      BB_Middle: 714.7175018310547,
      BB_Upper: 743.1724342597153,
      BB_Lower: 686.2625694023942,
      'Stoch_%K': 45.818305246128546,
      'Stoch_%D': 54.31652509187299,
      ATR: 14.903253173828125
    },
    {
      name: '2025-07-16',
      Open: 713.3699951171875,
      High: 713.969970703125,
      Low: 699.27001953125,
      Close: 702.9099731445312,
      Volume: 13049900,
      Dividends: 0,
      'Stock Splits': 0,
      SMA_20: 714.7570007324218,
      EMA_20: 710.1833052024333,
      RSI: 50.24042149828494,
      MACD: 11.370379439934368,
      MACD_Signal: 16.187653706768735,
      MACD_Hist: -4.817274266834367,
      BB_Middle: 714.7570007324218,
      BB_Upper: 743.1404075148184,
      BB_Lower: 686.3735939500252,
      'Stoch_%K': 35.01368727766439,
      'Stoch_%D': 47.28680393617598,
      ATR: 14.397998046875
    }
  ],
  company_info: {
    address1: '1 Meta Way',
    city: 'Menlo Park',
    state: 'CA',
    zip: '94025',
    country: 'United States',
    phone: '650 543 4800',
    website: 'https://investor.atmeta.com',
    industry: 'Internet Content & Information',
    industryKey: 'internet-content-information',
    industryDisp: 'Internet Content & Information',
    sector: 'Communication Services',
    sectorKey: 'communication-services',
    sectorDisp: 'Communication Services',
    longBusinessSummary: 'Meta Platforms, Inc. engages in the development of products that enable people to connect and share with friends and family through mobile devices, personal computers, virtual reality and mixed reality headsets, augmented reality, and wearables worldwide. It operates through two segments, Family of Apps (FoA) and Reality Labs (RL). The FoA segment offers Facebook, which enables people to build community through feed, reels, stories, groups, marketplace, and other; Instagram that brings people closer through instagram feed, stories, reels, live, and messaging; Messenger, a messaging application for people to connect with friends, family, communities, and businesses across platforms and devices through text, audio, and video calls; Threads, an application for text-based updates and public conversations; and WhatsApp, a messaging application that is used by people and businesses to communicate and transact in a private way. The RL segment provides virtual, augmented, and mixed reality related products comprising consumer hardware, software, and content that help people feel connected, anytime, and anywhere. The company was formerly known as Facebook, Inc. and changed its name to Meta Platforms, Inc. in October 2021. The company was incorporated in 2004 and is headquartered in Menlo Park, California.',
    fullTimeEmployees: 76834,
    companyOfficers: [
      [Object], [Object],
      [Object], [Object],
      [Object], [Object],
      [Object], [Object],
      [Object], [Object]
    ],
    auditRisk: 9,
    boardRisk: 10,
    compensationRisk: 10,
    shareHolderRightsRisk: 10,
    overallRisk: 10,
    governanceEpochDate: 1748736000,
    compensationAsOfEpochDate: 1735603200,
    executiveTeam: [],
    maxAge: 86400,
    priceHint: 2,
    previousClose: 710.39,
    open: 713.37,
    dayLow: 699.2701,
    dayHigh: 713.97,
    regularMarketPreviousClose: 710.39,
    regularMarketOpen: 713.37,
    regularMarketDayLow: 699.2701,
    regularMarketDayHigh: 713.97,
    dividendRate: 2.1,
    dividendYield: 0.28,
    exDividendDate: 1750032000,
    payoutRatio: 0.0792,
    beta: 1.266,
    trailingPE: 27.468151,
    forwardPE: 27.783003,
    volume: 13015507,
    regularMarketVolume: 13015507,
    averageVolume: 13342736,
    averageVolume10days: 10089050,
    averageDailyVolume10Day: 10089050,
    bid: 701.8,
    ask: 703.04,
    bidSize: 1,
    askSize: 1,
    marketCap: 1767347716096,
    fiftyTwoWeekLow: 442.65,
    fiftyTwoWeekHigh: 747.9,
    priceToSalesTrailing12Months: 10.374194,
    fiftyDayAverage: 676.803,
    twoHundredDayAverage: 620.9894,
    trailingAnnualDividendRate: 2.025,
    trailingAnnualDividendYield: 0.002850547,
    currency: 'USD',
    tradeable: false,
    enterpriseValue: 1835088740352,
    profitMargins: 0.39113998,
    floatShares: 2166721507,
    sharesOutstanding: 2171150080,
    sharesShort: 30138882,
    sharesShortPriorMonth: 35573940,
    sharesShortPreviousMonthDate: 1747267200,
    dateShortInterest: 1749772800,
    sharesPercentSharesOut: 0.012,
    heldPercentInsiders: 0.00068999996,
    heldPercentInstitutions: 0.8001,
    shortRatio: 2.59,
    shortPercentOfFloat: 0.0139,
    impliedSharesOutstanding: 2514330112,
    bookValue: 73.337,
    priceToBook: 9.584657,
    lastFiscalYearEnd: 1735603200,
    nextFiscalYearEnd: 1767139200,
    mostRecentQuarter: 1743379200,
    earningsQuarterlyGrowth: 0.346,
    netIncomeToCommon: 66635001856,
    trailingEps: 25.59,
    forwardEps: 25.3,
    enterpriseToRevenue: 10.772,
    enterpriseToEbitda: 20.858,
    '52WeekChange': 0.47716713,
    SandP52WeekChange: 0.12969577,
    lastDividendValue: 0.525,
    lastDividendDate: 1750032000,
    quoteType: 'EQUITY',
    currentPrice: 702.91,
    targetHighPrice: 935,
    targetLowPrice: 525,
    targetMeanPrice: 729.36505,
    targetMedianPrice: 735,
    recommendationMean: 1.47826,
    recommendationKey: 'strong_buy',
    numberOfAnalystOpinions: 63,
    totalCash: 70229999616,
    totalCashPerShare: 27.932,
    ebitda: 87979999232,
    totalDebt: 49519001600,
    quickRatio: 2.501,
    currentRatio: 2.662,
    totalRevenue: 170359996416,
    debtToEquity: 26.763,
    revenuePerShare: 67.349,
    returnOnAssets: 0.17879999,
    returnOnEquity: 0.39835,
    grossProfits: 139297996800,
    freeCashflow: 36658999296,
    operatingCashflow: 96108003328,
    earningsGrowth: 0.365,
    revenueGrowth: 0.161,
    grossMargins: 0.81767,
    ebitdaMargins: 0.51644003,
    operatingMargins: 0.41487,
    financialCurrency: 'USD',
    symbol: 'META',
    language: 'en-US',
    region: 'US',
    typeDisp: 'Equity',
    quoteSourceName: 'Nasdaq Real Time Price',
    triggerable: true,
    customPriceAlertConfidence: 'HIGH',
    corporateActions: [],
    preMarketTime: 1752745286,
    regularMarketTime: 1752696001,
    exchange: 'NMS',
    messageBoardId: 'finmb_20765463',
    exchangeTimezoneName: 'America/New_York',
    exchangeTimezoneShortName: 'EDT',
    gmtOffSetMilliseconds: -14400000,
    market: 'us_market',
    esgPopulated: false,
    regularMarketChangePercent: -1.05295,
    regularMarketPrice: 702.91,
    marketState: 'PRE',
    hasPrePostMarketData: true,
    firstTradeDateMilliseconds: 1337347800000,
    preMarketChange: 4.4900513,
    preMarketChangePercent: 0.6387804,
    preMarketPrice: 707.4,
    regularMarketChange: -7.48004,
    regularMarketDayRange: '699.2701 - 713.97',
    fullExchangeName: 'NasdaqGS',
    averageDailyVolume3Month: 13342736,
    fiftyTwoWeekLowChange: 260.25998,
    fiftyTwoWeekLowChangePercent: 0.5879589,
    fiftyTwoWeekRange: '442.65 - 747.9',
    fiftyTwoWeekHighChange: -44.99005,
    fiftyTwoWeekHighChangePercent: -0.06015517,
    fiftyTwoWeekChangePercent: 47.716713,
    dividendDate: 1750896000,
    earningsTimestamp: 1753905600,
    earningsTimestampStart: 1753905600,
    earningsTimestampEnd: 1753905600,
    earningsCallTimestampStart: 1753909200,
    earningsCallTimestampEnd: 1753909200,
    isEarningsDateEstimate: false,
    epsTrailingTwelveMonths: 25.59,
    epsForward: 25.3,
    epsCurrentYear: 25.56422,
    priceEpsCurrentYear: 27.49585,
    fiftyDayAverageChange: 26.106995,
    fiftyDayAverageChangePercent: 0.038573995,
    twoHundredDayAverageChange: 81.92059,
    twoHundredDayAverageChangePercent: 0.13191947,
    sourceInterval: 15,
    exchangeDataDelayedBy: 0,
    ipoExpectedDate: '2022-06-09',
    averageAnalystRating: '1.5 - Strong Buy',
    cryptoTradeable: false,
    shortName: 'Meta Platforms, Inc.',
    longName: 'Meta Platforms, Inc.',
    displayName: 'Meta Platforms',
    trailingPegRatio: 2.3221
  },
  analyst_recommendations: {
    period: { '0': '0m', '1': '-1m', '2': '-2m' },
    strongBuy: { '0': 13, '1': 13, '2': 14 },
    buy: { '0': 47, '1': 47, '2': 46 },
    hold: { '0': 7, '1': 6, '2': 6 },
    sell: { '0': 0, '1': 0, '2': 0 },
    strongSell: { '0': 2, '1': 2, '2': 2 }
  },
  news: [
    {
      id: '68e36e50-c36b-4594-9064-ddda13080104',
      content: {
        title: 'OpenAI Releases New GPT-5 Model With Multimodal Capabilities',
        clickThroughUrl: { url: 'https://example.com/news1' },
        thumbnail: { originalUrl: 'https://via.placeholder.com/150' },
        provider: { displayName: 'TechCrunch' },
        pubDate: new Date().toISOString(),
      },
    },
    {
      id: 'bb0a5ace-1e9a-3c20-8afe-5884edc92db8',
      content: {
        title: 'India Sets New Record in Space Launch With Gaganyaan Test',
        clickThroughUrl: { url: 'https://example.com/news2' },
        thumbnail: { originalUrl: 'https://via.placeholder.com/150' },
        provider: { displayName: 'NDTV' },
        pubDate: new Date().toISOString(),
      },
    },
    {
      id: '4a009602-648c-4f30-80c6-fef1aebad053',
      content: {
        title: 'Stock Markets Surge As AI Startups Show Record Growth',
        clickThroughUrl: { url: 'https://example.com/news3' },
        thumbnail: { originalUrl: 'https://via.placeholder.com/150' },
        provider: { displayName: 'Bloomberg' },
        pubDate: new Date().toISOString(),
      },
    },
    {
      id: '3b3d5f1f-af28-3341-8764-c02a6d29ce2e',
      content: {
        title: 'ChatGPT Plugin Store Hits 1 Million Downloads in First Month',
        clickThroughUrl: { url: 'https://example.com/news4' },
        thumbnail: { originalUrl: 'https://via.placeholder.com/150' },
        provider: { displayName: 'Wired' },
        pubDate: new Date().toISOString(),
      },
    },
    {
      id: '53c1a6fb-98e9-39a3-a053-41629b4677d7',
      content: {
        title: 'New Breakthrough in Quantum Computing Announced by Google',
        clickThroughUrl: { url: 'https://example.com/news5' },
        thumbnail: { originalUrl: 'https://via.placeholder.com/150' },
        provider: { displayName: 'Google AI Blog' },
        pubDate: new Date().toISOString(),
      },
    },
    {
      id: 'bdc7536f-48b9-36a5-8c2b-ccdb13412b0f',
      content: {
        title: 'Meta Introduces LLaMA 4: Smaller, Smarter, and Safer',
        clickThroughUrl: { url: 'https://example.com/news6' },
        thumbnail: { originalUrl: 'https://via.placeholder.com/150' },
        provider: { displayName: 'The Verge' },
        pubDate: new Date().toISOString(),
      },
    },
    {
      id: '71d4763e-da8d-3b46-b590-5635a1eddf49',
      content: {
        title: 'Elon Musk Announces xAI Agent To Rival ChatGPT',
        clickThroughUrl: { url: 'https://example.com/news7' },
        thumbnail: { originalUrl: 'https://via.placeholder.com/150' },
        provider: { displayName: 'Reuters' },
        pubDate: new Date().toISOString(),
      },
    },
    {
      id: 'b9ef8645-9d7c-3c6b-a6e1-7ee9393e659f',
      content: {
        title: 'Apple’s New iPhone 17 AI Chip Promises Unprecedented Speed',
        clickThroughUrl: { url: 'https://example.com/news8' },
        thumbnail: { originalUrl: 'https://via.placeholder.com/150' },
        provider: { displayName: 'MacRumors' },
        pubDate: new Date().toISOString(),
      },
    },
    {
      id: 'e19c8055-5d51-3d64-b04e-076d50caadae',
      content: {
        title: 'Microsoft Copilot Rolls Out To All Office 365 Users',
        clickThroughUrl: { url: 'https://example.com/news9' },
        thumbnail: { originalUrl: 'https://via.placeholder.com/150' },
        provider: { displayName: 'Microsoft Blog' },
        pubDate: new Date().toISOString(),
      },
    },
    {
      id: '42d666c7-eb53-365e-a72d-7c043b0055a6',
      content: {
        title: 'Anthropic’s Claude 3.5 Surpasses GPT-4 in Reasoning Tasks',
        clickThroughUrl: { url: 'https://example.com/news10' },
        thumbnail: { originalUrl: 'https://via.placeholder.com/150' },
        provider: { displayName: 'VentureBeat' },
        pubDate: new Date().toISOString(),
      },
    },
  ]
}
// POST /companystock
exports.selectCompany = async (req, res) => {
  // console.log("Received body:", req.body);
  const { name, symbol } = req.body;
  try {
    const response = await axios.post(`${PYTHON_BACKEND_URL}/run-stock-analysis`, {
        company_name: name,
        symbol: symbol
    });
    // console.log("response from python : ",response.data);
    res.json(response.data);
  } catch (error) {
      // console.error("Error:", error.response?.data || error.message);

      res.json(dummyData);
  }
};

exports.PredictPrices = async (req, res) => {
  const { symbol, days } = req.body;
  try {
    const response = await axios.post(`${PYTHON_BACKEND_URL}/predict-prices`, {
      symbol: symbol,
      days: days
    });
    const data = await response.json();
    res.json(data);
  } catch (err) {
    // console.error("Error fetching prediction:", err);
    const today = new Date();
    const dummyPredictions = Array.from({ length: days }, (_, i) => {
      const nextDay = new Date(today);
      nextDay.setDate(today.getDate() + i + 1);

      return {
        date: nextDay.toISOString().split('T')[0],
        predicted_close: parseFloat((100 + Math.random() * 10).toFixed(2)) // $100 - $110 range
      };
    });
    return res.status(200).json({
      ticker: symbol,
      source: "dummy",
      predictions: dummyPredictions
    });
  }
}
